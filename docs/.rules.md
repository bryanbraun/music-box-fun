# Music Box Fun - Rules for AI Assistants

## Architecture Philosophy
This codebase follows strict "no nonsense" principles: low cost, low maintenance, prioritizing user experience over developer convenience. Prefer vanilla solutions over frameworks, minimal dependencies over convenience packages, and simple approaches over complex abstractions.

## Frontend (site/) - Alt-React Architecture

### Component System
- **Framework**: Custom "Alt-React" system with NO React, JSX, or build tools
- **Base Classes**: Components inherit from `MBComponent` (which extends `BaseComponent`)
- **File Location**: All components in `site/public/js/components/`
- **Imports**: Always use relative paths with `.js` extensions: `import { Component } from './component.js'`

### Component Structure Pattern
```javascript
import { MBComponent } from './music-box-component.js';
import { musicBoxStore } from '../music-box-store.js';

export class ComponentName extends MBComponent {
  constructor(props) {
    super({
      props,
      renderTrigger: 'state.path', // or ['multiple', 'paths'] or omit if no reactive updates
      element: document.querySelector('#element-id')
    });

    // Local state initialization
    this.state.localProperty = initialValue;

    // Bind event handlers in constructor to access ComponentName data and methods
    this.handleEvent = this.handleEvent.bind(this);
  }

  handleEvent(event) {
    // For local state changes
    this.setState({ localProperty: newValue });

    // For global state changes
    musicBoxStore.setState('statePath.property', newValue);
  }

  render() {
    // Use template strings (NO JSX)
    this.element.innerHTML = `
      <div class="component-class">
        ${this.props.someProp}
        ${musicBoxStore.state.someGlobalState}
      </div>
    `;

    // Add event listeners AFTER innerHTML assignment
    this.element.querySelector('.selector').addEventListener('event', this.handleEvent);
  }
}
```

### State Management
- **Global State**: Use `musicBoxStore.setState('path.to.property', value)` for cross-component state
- **Local State**: Use `this.setState({ property: value })` for component-specific state
- **State Structure**: Reference `site/public/js/state.js` for the global state shape
- **Render Triggers**: Use renderTrigger to auto-rerender components on global state changes: `'statePath'`, `'statePath*'` (wildcard), or `['multiple', 'paths']`

### Module System
- **ES6 Modules**: Import/export with full paths: `./component.js`, `../utils.js`
- **No Build Process**: Code runs directly in browser, no Babel/Webpack/bundlers
- **Entry Point**: `site/public/js/app-entry.js` initializes all components
- **Dependencies**: Installed with npm. All application JS uses esinstall to create a one-time build, (commited to the `vendor` directory) which ensures ES6 Module compatibility.

### Event Handling
- **Binding**: Always bind in constructor: `this.method = this.method.bind(this)`
- **DOM Events**: Use `addEventListener`, not inline handlers
- **Event Delegation**: Use on parent elements when appropriate
- **Global Events**: Where renderTrigger is not possible, you can publish or subscribe directly to global events: `musicBoxStore.publish('event', payload)` `musicBoxStore.subscribe('event', callback)` (note: prefer renderTrigger over `.subscribe`).

### CSS & Styling
- **No CSS-in-JS**: Use traditional CSS files in `site/public/css/`
- **Naming**: BEM-like conventions: `.component-name`, `.component-name__element`, `.component-name--modifier`
- **CSS Custom Properties**: Use `--variable-name` for theming (see `variables.css`)
- **Responsive**: Use CSS media queries with documented breakpoints
- **Modular**: Separate files by purpose: `base.css`, `app.css`, `components.css`
- **Performance**: Where possible, prefer CSS solutions over JavaScript solutions for better performance and simplicity (sticky headers, animations, CSS variables, etc)

### File Organization
- **Components**: `site/public/js/components/[component-name].js`
- **Utils**: `site/public/js/common/[util-name].js`
- **Store**: `site/public/js/music-box-store.js`
- **Constants**: `site/public/js/constants.js`
- **CSS**: `site/public/css/[purpose].css`

## Backend (api/) - Rails API

### Controller Patterns
- **API-only**: Rails in API mode, JSON responses only
- **Minimal Logic**: Keep controllers thin, basic CRUD operations
- **Caching**: Use `expires_in` for appropriate endpoints
- **CORS**: Configured in `config/initializers/cors.rb`
- **Error Handling**: Simple JSON error responses

### Model Patterns
- **ActiveRecord**: Standard Rails models with minimal complexity
- **Search**: Use `pg_search` for full-text search capabilities
- **Migrations**: Keep database changes simple and backwards compatible

### API Endpoints
- **Versioning**: Namespace under `/v1/`
- **Pagination**: Include `meta` object with pagination info
- **Search**: Support `q` parameter for search queries
- **RESTful**: Follow standard REST conventions

## Development Workflow

### Local Development
- **Frontend**: Serve with Caddy (`make dev`)
- **Backend**: Docker-compose with Rails and PostgreSQL
- **No Build Step**: Save file, refresh browser - that's it
- **Dependencies**: Add to package.json, use esinstall for application JavaScript.

### File Naming
- **JavaScript**: kebab-case for files: `component-name.js`
- **CSS**: kebab-case for files: `component-styles.css`
- **Classes**: PascalCase for components: `ComponentName`
- **CSS Classes**: BEM convention: `.block__element--modifier`

### Testing
- **No Unit Tests**: Philosophy is to avoid unit tests
- **Cypress**: E2E tests that resemble real usage in `site/cypress/`
- **Browser Testing**: Test in actual browsers, not emulated environments

## Code Style & Conventions

### JavaScript
- **ES6+**: Use modern JavaScript features (arrow functions, const/let, template strings)
- **No Transpilation**: Code must run natively in modern browsers
- **Imports**: Always use file extensions and relative/absolute paths
- **Comments**: Use comprehensive comments explaining WHY, if intent cannot be clearly determined from the code

### HTML
- **Semantic**: Use proper semantic HTML elements
- **IDs**: Required for components that use renderTrigger
- **Classes**: Use for styling, IDs for JavaScript selection
- **Entry Point**: `site/public/index.html` Used for initial static page load, with ID hooks for mounting components. Update this page as components change to reduce layout shifting when components mount.

### Performance
- **Caching**: Leverage browser caching and ETags
- **ES Modules**: Benefits from granular caching of individual modules
- **Minimal Dependencies**: Prefer vanilla solutions to reduce bundle size

## Anti-Patterns to Avoid

### Don't Use
- **React/Vue/Angular**: Use the custom Alt-React system instead
- **JSX**: Use template strings
- **Build Tools**: No Webpack, Babel, Parcel, etc.
- **npm run dev**: No build processes or file watchers
- **CSS-in-JS**: Use traditional CSS files
- **Heavy Dependencies**: Prefer lightweight or vanilla solutions
- **Complex State Management**: Keep state simple and direct

### Don't Do
- **Inline Styles**: Use CSS classes
- **Global Variables**: Use proper module imports/exports
- **Complex Abstractions**: Keep code simple and maintainable
- **Premature Optimization**: Add complexity only when actually needed

## Browser Support
- **Modern Browsers**: Target browsers with ES6 module support (>90% global usage)

## Deployment
- **Static Frontend**: Deploy as static files to Netlify/CDN
- **Docker Backend**: Rails API runs in Docker containers
- **Environment Variables**: Use environment sniffing for frontend config
- **Caching**: Leverage CDN and browser caching for performance

Remember: This codebase prioritizes simplicity, maintainability, and direct solutions over industry trends or complex tooling. When in doubt, choose the simpler approach that requires less maintenance.
